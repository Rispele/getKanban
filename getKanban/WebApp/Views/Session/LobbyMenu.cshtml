@using Domain.Game
@model Core.Dtos.GameSessionDto

@{ var isAdmin = ((Model.RequesterRole & ParticipantRole.Creator) == ParticipantRole.Creator); }
@{
    var allPlayerIds = Model.Teams
        .SelectMany(x => x.Participants.Users)
        .Select(x => x.Id)
        .Concat(
            Model.Angels.Participants.Users
                .Select(x => x.Id));
}

<div class="commandEditorHeader text-center">
    <h1 class="display-4 fw-bold">getKanban: "@Model.Name"</h1>
</div>

<div class="commandEditorContainer centered-25">
    <div class="commandEditorLWindow commandEditorWindowsHeight commandEditorBorderStyle commandEditorBorderWidth commandEditorBorderRadius">
        @foreach (var team in Model.Teams)
        {
            <div class="commandEditorCommandContainer commandEditorBorderRadius">
                <div class="commandEditorHeaders text-center" id="headers-@team.Id"></div>
                <div class="commandEditorNamesContainer text-center" id="@team.Id">
                    @foreach (var player in team.Participants.Users)
                    {
                        <p class="fs-6" id="@player.Id">@player.Name
                        @if (isAdmin)
                        {
                            <img src="/images/remove_button.svg" alt="edit" width="20" height="20" style="cursor:pointer" id="remove-@player.Id">
                        }
                        </p>
                    }
                </div>
            </div>
        }
    </div>
    <div class="commandEditorSWindow commandEditorWindowsHeight commandEditorBorderStyle commandEditorBorderWidth commandEditorBorderRadius">
        <div class="commandEditorHeaders text-center" id="headers-@Model.Angels.Id"></div>
        <div class="commandEditorNamesContainer angelsEditor text-center" id="@Model.Angels.Id">
            @foreach (var player in Model.Angels.Participants.Users)
            {
                <p class="fs-6" id="@player.Id">@player.Name
                @if (isAdmin && player.Id != Model.RequesterId)
                {
                    <img src="/images/remove_button.svg" alt="edit" width="20" height="20" style="cursor:pointer" id="remove-@player.Id">
                }
                </p>
            }
        </div>
    </div>
</div>

<button class="commandEditorButtonsTemplate authorizationButton" type="button" id="disconnect">Разорвать соединение</button>
<button class="commandEditorButtonsTemplate authorizationButton" type="button" id="connect">Установить соединение</button>

@if (isAdmin)
{
    <form class="text-center">
        <button class="commandEditorButtonsTemplate authorizationButton" type="button" id="close">Закрыть игру</button>
    </form>
    <form class="text-center">
        <button class="commandEditorButtonsTemplate authorizationButton" type="button" id="start">Начать игру</button>
    </form>
}
else
{
    <form class="text-center">
        <button class="commandEditorButtonsTemplate authorizationButton" type="button" id="leave">Покинуть игру</button>
    </form>
}

<script src="/js/signalr/dist/browser/signalr.js"></script>
<script type="module" async="async">
    const isCurrentUserAdmin = @(((Model.RequesterRole & ParticipantRole.Creator) == ParticipantRole.Creator).ToString().ToLower());
    
    const connection = new signalR.HubConnectionBuilder().withUrl("/lobbyHub").build();
    await connection.start()
    .then(function () {
        let path = window.location.pathname.split("session/")[1];
        path = path.split("/lobby-menu")[0];
        const inviteCode = path.replace("/", ".");
    
        connection.invoke("CheckPlayerJoined", inviteCode);
        connection.on("NotifyPlayerCheck", function (hasJoined, userId) {
            if (!hasJoined) {
                fetch(`/session/join?inviteCode=${inviteCode}`, {redirect: "follow"})
                    .then(sessionId => sessionId.json())
                    .then(sessionId => {
                        if (sessionId.length === 0) {
                            showMessage("Невозможно присоединиться к сессии с данным кодом приглашения");
                            return;
                        }
                        window.location.href = `/session/${sessionId}`;
                    })
            }
        });
    })
    .then(function () {
        connection.invoke("JoinGame", "@Model.Id");
    });

    connection.on("NotifyClosed", function () {
        window.location.href = "/";
    });
    connection.on("NotifyLeft", function (userId) {
        const cookieUserId = document.cookie
            .split("; ")
            .find((row) => row.startsWith("userId="))
            ?.split("=")[1];
        if (userId === cookieUserId) {
            window.location.href = "/";
            return;
        }
        const playerElement = document.getElementById(userId.toString());
        const playerName = playerElement.textContent;
        playerElement.remove();
        showMessage(`Игрок ${playerName} покидает игру`, false);
    });
    connection.on("NotifyConnectionRestore", function (userId) {
        const playerElement = document.getElementById(userId);
        
        const images = playerElement.getElementsByTagName("img");
        for (let img of images) {
            if (img.id === `connection-lost-${userId}`) {
                img.remove();
            }
        }
    });
    connection.on("NotifyConnectionLost", function (userId) {
        const playerElement = document.getElementById(userId);
        
        const images = playerElement.getElementsByTagName("img");
        for (let img of images) {
            if (img.id === `connection-lost-${userId}`) {
                img.remove();
            }
        }
        
        const connectionLostIcon = buildIcon(`connection-lost-${userId}`, "/images/disconnected_icon.svg");
        playerElement.appendChild(connectionLostIcon);
    });
    connection.on("NotifyJoined", function (teamId, userId, userName) {
        const teamBlock = document.getElementById(teamId);
        const teamPlayers = teamBlock.getElementsByClassName("fs-6");
        for (let pl of teamPlayers) {
            if (pl.id === userId) { return; }
        }
        let playerElementInOtherTeam = document.getElementById(userId.toString());
        if (playerElementInOtherTeam !== null && playerElementInOtherTeam !== undefined) {
            playerElementInOtherTeam.remove();
        }
    
        const playerElement = document.createElement("p");
        playerElement.setAttribute("class", "fs-6");
        playerElement.setAttribute("id", userId.toString());
        playerElement.textContent = userName.toString();
        
        const team = document.getElementById(teamId);
        
        if (isCurrentUserAdmin) {
            const removeButton = buildIcon(`remove-${userId}`, "/images/remove_button.svg");
            removeButton.addEventListener('click', function () {
                connection.invoke("RemovePlayer", "@Model.Id", userId);
            });
            playerElement.appendChild(removeButton);
        }
        
        team.appendChild(playerElement);
        
        const teamName = document.getElementById(`headers-${teamId}`).innerText;
        showMessage(`Игрок ${userName.toString()} присоединяется к команде "${teamName}"`, false);
    });
    connection.on("NotifyStarted", async function () {
        await fetch("/session/get-current-team?sessionId=@Model.Id")
            .then(async response => {
                const teamDto = JSON.parse(await response.text());
                if (teamDto["name"] === "Ангелы") {
                    window.location.href = `/admin?sessionId=@Model.Id`;
                } else {
                    window.location.href = `/@Model.Id/${teamDto["id"]}/step/1`;
                }
            })
    });
    connection.on("NotifyRenamed", function (teamId, teamName) {
        refreshTeamsHeaders(teamId, teamName)
    });
    
    const startButton = document.getElementById("start");
    if (startButton !== null && startButton !== undefined) {
        startButton.addEventListener('click', function () {
            connection.invoke("StartGame", "@Model.Id")
                .then(function () {});
        });
    }

    const leaveButton = document.getElementById("leave");
    if (leaveButton !== null && leaveButton !== undefined) {
        leaveButton.addEventListener('click', function () {
            connection.invoke("LeaveGame", "@Model.Id")
                .then(function () { window.location.href = "/" });
        });
    }

    const closeButton = document.getElementById("close");
    if (closeButton !== null && closeButton !== undefined) {
        closeButton.addEventListener('click', function () {
            connection.invoke("CloseGame", "@Model.Id")
                .then(function () { window.location.href = "/" });
        });
    }

    document.getElementById('disconnect').addEventListener('click', function () {
        connection.stop();
    });
    document.getElementById('connect').addEventListener('click', function () {
        connection.start();
    });

    const currentTeamJson = await fetch("/session/get-current-team?sessionId=@Model.Id")
        .then(r => r.text())
        .then(data => {
            if (data.length > 0) {
                return JSON.parse(data);
            } else {
            }
        });

    let currentTeamId = currentTeamJson["id"];
    let currentTeamName = currentTeamJson["name"];
    let currentTeamLink = currentTeamJson["participants"]["inviteCode"];

    //window.onbeforeunload = function () {
    //    if (shouldLeave) {
    //        connection.invoke("LeaveGame", "@Model.Id");
    //    }
    //};

    const teamLinks = [];
    const teamIds = [];
    const teamNames = [];
    @foreach (var team in Model.Teams)
    {
        @:teamLinks.push("@team.Participants.InviteCode");
        @:teamIds.push("@team.Id");
        @:teamNames.push("@Html.Raw(team.Name)");
    }
    teamLinks.push("@Model.Angels.Participants.InviteCode");
    teamIds.push("@Model.Angels.Id");
    teamNames.push("@Html.Raw(Model.Angels.Name)");

    refreshTeamsHeaders();

    function refreshTeamsHeaders(renameTeamId = null, renameTeamName = null) {
        if (renameTeamId !== null) {
            teamNames[teamIds.indexOf(renameTeamId)] = renameTeamName;
        }

        if (isCurrentUserAdmin) {
            @foreach (var id in allPlayerIds.Except([Model.RequesterId]))
            {
                <text>
                    document.getElementById('remove-@id').addEventListener('click', function () {
                        connection.invoke("RemovePlayer", "@Model.Id", "@id");
                    });
                </text>
            }
        
            for (let i = 0; i < teamIds.length; i++) {
                recreateEditBlock(teamIds[i]);
            }
            placeTeamNameEditButtons(teamIds.filter(function (x) {return x !== "@Model.Angels.Id"}));
            placeTeamNames(teamIds, teamNames);
            placeTeamLinks(teamNames, teamIds, teamLinks);
        } else if (currentTeamId !== null) {
            for (let i = 0; i < teamIds.length; i++) {
                recreateEditBlock(teamIds[i]);
            }
            if (currentTeamId !== "@Model.Angels.Id") placeTeamNameEditButtons([currentTeamId]);
            placeTeamNames(teamIds, teamNames);
        }
    }

    function placeTeamNameEditButtons(teamIds) {
        for (let teamId of teamIds) {
            const icon = buildIcon(`edit-button-${teamId}`, "/images/edit_button.svg");
            icon.addEventListener("click", function () { replaceWithInput(teamId) });
            getOrCreateEditBlock(teamId).appendChild(icon);
        }

        function replaceWithInput(teamId){
            const headersBlock = document.getElementById(`headers-${teamId}`);
            headersBlock.innerHTML = '';

            const input = document.createElement("input");
            input.setAttribute("id", `edit-input-${teamId}`);

            const saveButton = document.createElement("button");
            saveButton.setAttribute("id", `edit-submit-${teamId}`);
            saveButton.innerText = "Сохранить";
            saveButton.addEventListener("click", function () {
                const teamName = input.value.toString();
                if (teamName.length > 0) {
                    fetch(`/session/update-team-name?sessionId=@Model.Id&teamId=${teamId}&name=${teamName}`)
                        .then(function () {
                            connection.invoke("UpdateName", "@Model.Id", teamId)
                                .then(function () {
                                    refreshTeamsHeaders(teamId, teamName);
                                });
                        });
                }
            });
            
            const backButton = document.createElement("button");
            backButton.setAttribute("id", `edit-back-${teamId}`);
            backButton.innerText = "Назад";
            backButton.addEventListener("click", function () {
                refreshTeamsHeaders();
            });

            const editBlock = getOrCreateEditBlock(teamId)
            editBlock.appendChild(saveButton);
            editBlock.appendChild(input);
            editBlock.appendChild(backButton);
        }
    }

    function placeTeamNames(teamIds, teamNames) {
        for (let i = 0; i < teamIds.length; i++) {
            const text = document.createElement("p");
            text.setAttribute("id", `edit-name-${teamIds[i]}`)
            text.innerText = teamNames[i];
            getOrCreateEditBlock(teamIds[i]).appendChild(text);
        }
    }

    function placeTeamLinks(teamNames, teamIds, teamInviteLinks) {
        for (let i = 0; i < teamIds.length; i++) {
            const teamIcon = buildIcon(`link-${teamInviteLinks[i]}`, "/images/link_button.svg");
            teamIcon.addEventListener('click', function () {
                navigator.clipboard.writeText(teamInviteLinks[i])
                    .then(() => showMessage(`Код приглашения в команду "${teamNames[i]}" скопирован`, false))
            });
            getOrCreateEditBlock(teamIds[i]).appendChild(teamIcon);
        }
    }

    function buildIcon(iconId, imgPath, clickable=true) {
        const image = document.createElement("img");
        image.setAttribute("src", imgPath);
        image.setAttribute("alt", "edit");
        image.setAttribute("width", "20");
        image.setAttribute("height", "20");
        if (clickable) image.setAttribute("style", "cursor:pointer");
        image.setAttribute("id", iconId);
        return image;
    }

    function recreateEditBlock(teamId) {
        let editBlock = document.getElementById(`edit-${teamId}`);
        if (editBlock !== null && editBlock !== undefined) {
            editBlock.remove();
        }
        editBlock = document.createElement("p");
        editBlock.setAttribute("class", "fs-6");
        editBlock.setAttribute("id", `edit-${teamId}`);
        document.getElementById(`headers-${teamId}`).appendChild(editBlock);
        return editBlock;
    }

    function getOrCreateEditBlock(teamId) {
        let editBlock = document.getElementById(`edit-${teamId}`);
        return editBlock !== null && editBlock !== undefined ? editBlock : recreateEditBlock(teamId);
    }

</script>