@using Core.Dtos.Containers.RollDice
@using Core.Dtos.Containers.TeamMembers
@model (Guid currentSessionId, int dayNumber, RollDiceContainerDto diceResults)

<div class="stepHeader">
    <h1 class="fs-1 fw- text-center">Команда pipipupu. День @Model.dayNumber</h1>
</div>

@functions
{
    private IEnumerable<int> SelectDiceNumber(TeamRoleDto initialRole) =>
        GetDiceRollResultsByCurrentRole(initialRole)
            .Select(t => t.DiceNumber);

    private IEnumerable<string> SelectScores(TeamRoleDto currentRole)
    {
        var rolls = GetDiceRollResultsByCurrentRole(currentRole).ToList();
        var sum = rolls.Sum(t => t.Scores);
        // return rolls
        //     .Select(
        //         t => t.InitialRole != t.CurrentRole
        //             ? $"{t.InitialRole} -> {t.CurrentRole} {t.Scores}"
        //             : $"{t.InitialRole} {t.Scores}")
        //     .Concat([$"Сумма: {sum}"]);
        return [sum.ToString()];
    }

    private IEnumerable<DiceRollResultDto> GetDiceRollResultsByCurrentRole(TeamRoleDto currentRole) =>
        Model.diceResults.DiceRollResults
            .Where(t => t.CurrentRole == currentRole);
}

<div class="main-container">

    <h1 class="title">Кубик брошен.</h1>
    <h1 class="title">Уменьшите работы в тикетах соответственно таблице</h1>
    <hr class="divider">

    <div class="main-container2">
        <!-- Таблица, реализованная через div -->
        <div class="role-table">
            <!-- Заголовок таблицы -->
            <div class="role-table-header">
                <div class="role-table-header-cell">Роль</div>
                <div class="role-table-header-cell">Сумма работ</div>
            </div>
            <!-- Строки таблицы -->
            <div class="role-table-row">
                <div class="role-table-cell">Аналитики</div>
                <div class="role-table-cell">
                    @foreach (var s in SelectScores(TeamRoleDto.Analyst))
                    {
                        <div>@s</div>
                    }
                </div>
            </div>
            <div class="role-table-row">
                <div class="role-table-cell">Разработчики</div>
                <div class="role-table-cell">
                    @foreach (var s in SelectScores(TeamRoleDto.Programmer))
                    {
                        <div>@s</div>
                    }
                </div>
                @* <div class="role-table-cell"><span>@string.Join("\n", SelectScores(TeamRoleDto.Programmer))</span></div> *@
            </div>
            <div class="role-table-row">
                <div class="role-table-cell">Тестировщики</div>
                <div class="role-table-cell">
                    @foreach (var s in SelectScores(TeamRoleDto.Tester))
                    {
                        <div>@s</div>
                    }
                </div>
                @* <div class="role-table-cell"><span>@string.Join("\n", SelectScores(TeamRoleDto.Tester))</span></div> *@
            </div>
        </div>

        <!-- Элемент справа -->
        <div class="right-element">
            <h1 class="fs-4 text-center">
                Доска
            </h1>

            <div class="info height-small centered-25">
                <p class="fs-5 fw-normal">
                    1) Остатки работ можно потратить в течение дня. Имейте в виду, что между днями неиспользованные работы сгорают.
                </p>
                <p class="fs-5 fw-normal">
                    2) При необходимости, переместите новые тикеты (проверьте, чтоб соблюдалось ограничение WIP).
                </p>
                <p class="fs-5 fw-normal">
                    3) Потратьте остаток работ на другие тикеты.
                </p>
            </div>
        </div>
    </div>

</div>

@* <div class="infoContainer height-large centered-100"> *@
@*     <h1 class="fs-4 text-center"> *@
@*         Доска *@
@*     </h1> *@
@*      *@
@*     <div class="info height-small centered-100"> *@
@*         <p class="fs-5 fw-normal">Остатки работ можно потратить в течение дня. Имейте в виду, что между днями неиспользованные работы сгорают.</p> *@
@*         <p class="fs-5 fw-normal">При необходимости, переместите новые тикеты (проверьте, чтоб соблюдалось ограничение WIP).</p> *@
@*         <p class="fs-5 fw-normal">Потратьте остаток работ на другие тикеты.</p> *@
@*     </div> *@
@*      *@
@*     <div> *@
@*         <p>Результат броска для аналитиков: @string.Join(" ", SelectDiceNumber(TeamRoleDto.Analyst))</p> *@
@*         <p>Результат броска для разработчиков: @string.Join(" ", SelectDiceNumber(TeamRoleDto.Programmer))</p> *@
@*         <p>Результат броска для тестировщиков: @string.Join(" ", SelectDiceNumber(TeamRoleDto.Tester))</p> *@
@*         <p>Итоговый счет для аналитиков: @string.Join(" ", SelectScores(TeamRoleDto.Analyst))</p> *@
@*         <p>Итоговый счет для разработчиков: @string.Join(" ", SelectScores(TeamRoleDto.Programmer))</p> *@
@*         <p>Итоговый счет для тестировщиков: @string.Join(" ", SelectScores(TeamRoleDto.Tester))</p> *@
@*     </div> *@
@* </div> *@

<button class="stepControlButtons rightButton" id="next">
    Далее
</button>

<script src="/js/signalr/dist/browser/signalr.js"></script>
<script>
    const connection = new signalR.HubConnectionBuilder().withUrl("/lobbyHub").build();
    connection.start()
        .then(function () {
            connection.invoke("Join", "@Model.currentSessionId");
        });
    connection.on("NotifyPageChange", function (page, stage) {
        window.location.href = `/step/${page}/${stage}`;
    });

    document.getElementById("next").addEventListener('click', function () {
        connection.invoke("ChangePage", "@Model.currentSessionId", 3, 0)
            .then(function () {
                window.location.href = `/step/3`;
            });
    });
</script>